<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next.js HMI Wiring Audit - Water Treatment Controller</title>
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --accent-blue: #38bdf8;
            --accent-green: #4ade80;
            --accent-yellow: #fbbf24;
            --accent-red: #f87171;
            --accent-purple: #a78bfa;
            --border: #475569;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }

        .container { max-width: 1400px; margin: 0 auto; }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 0.5rem;
            margin: 2rem 0 1rem;
        }

        h3 {
            color: var(--accent-green);
            margin: 1.5rem 0 0.75rem;
        }

        h4 {
            color: var(--accent-yellow);
            margin: 1rem 0 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 2rem;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 0.75rem;
            text-align: left;
            border: 1px solid var(--border);
        }

        th {
            background: var(--bg-card);
            color: var(--accent-blue);
            font-weight: 600;
        }

        tr:hover { background: rgba(56, 189, 248, 0.05); }

        code {
            background: var(--bg-card);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85em;
            color: var(--accent-green);
        }

        pre {
            background: var(--bg-card);
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            border: 1px solid var(--border);
        }

        pre code {
            background: none;
            padding: 0;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-blue { background: rgba(56, 189, 248, 0.2); color: var(--accent-blue); }
        .badge-green { background: rgba(74, 222, 128, 0.2); color: var(--accent-green); }
        .badge-yellow { background: rgba(251, 191, 36, 0.2); color: var(--accent-yellow); }
        .badge-red { background: rgba(248, 113, 113, 0.2); color: var(--accent-red); }
        .badge-purple { background: rgba(167, 139, 250, 0.2); color: var(--accent-purple); }

        .flow-diagram {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 2rem;
            margin: 1.5rem 0;
            font-family: monospace;
            white-space: pre;
            overflow-x: auto;
            line-height: 1.4;
        }

        .connection-line {
            color: var(--accent-blue);
        }

        .component-box {
            color: var(--accent-green);
        }

        .data-flow {
            color: var(--accent-yellow);
        }

        ul, ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        li { margin: 0.5rem 0; }

        .status-ok { color: var(--accent-green); }
        .status-warn { color: var(--accent-yellow); }
        .status-error { color: var(--accent-red); }

        .toc {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 2rem 0;
        }

        .toc a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .toc a:hover { color: var(--accent-blue); }

        .highlight { background: rgba(56, 189, 248, 0.1); padding: 0.1rem 0.3rem; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Next.js HMI Wiring Audit</h1>
            <p class="subtitle">Complete architecture analysis of the Water Treatment Controller SCADA/HMI</p>
            <p><span class="badge badge-blue">Next.js 14</span> <span class="badge badge-green">React 18</span> <span class="badge badge-purple">FastAPI Backend</span> <span class="badge badge-yellow">WebSocket</span></p>
        </header>

        <nav class="toc">
            <h3>Table of Contents</h3>
            <ol>
                <li><a href="#overview">System Overview</a></li>
                <li><a href="#architecture">Architecture Diagram</a></li>
                <li><a href="#frontend">Frontend Structure</a></li>
                <li><a href="#routing">Page Routing</a></li>
                <li><a href="#components">Component Hierarchy</a></li>
                <li><a href="#data-flow">Data Flow & State Management</a></li>
                <li><a href="#api">API Endpoints</a></li>
                <li><a href="#websocket">WebSocket Events</a></li>
                <li><a href="#auth">Authentication Flow</a></li>
                <li><a href="#config">Configuration</a></li>
                <li><a href="#html-output">HTML Output Sample</a></li>
            </ol>
        </nav>

        <section id="overview">
            <h2>1. System Overview</h2>
            <div class="card">
                <p>The Water Treatment Controller HMI is a <strong>Next.js 14 App Router</strong> application that provides a SCADA interface for monitoring and controlling water treatment RTUs (Remote Terminal Units).</p>

                <h4>Key Technologies</h4>
                <ul>
                    <li><strong>Frontend:</strong> Next.js 14, React 18, TypeScript, TailwindCSS</li>
                    <li><strong>Backend:</strong> FastAPI (Python), SQLAlchemy ORM, SQLite</li>
                    <li><strong>Real-time:</strong> WebSocket for push updates, polling fallback</li>
                    <li><strong>Industrial Standard:</strong> ISA-101 HMI Design, ISA-18.2 Alarm Management</li>
                </ul>

                <h4>Port Configuration</h4>
                <table>
                    <tr><th>Service</th><th>Port</th><th>Description</th></tr>
                    <tr><td>Next.js HMI</td><td><code>8080</code></td><td>Frontend UI server</td></tr>
                    <tr><td>FastAPI Backend</td><td><code>8000</code></td><td>REST API + WebSocket</td></tr>
                    <tr><td>PROFINET Controller</td><td>IPC/SHM</td><td>Shared memory interface</td></tr>
                </table>
            </div>
        </section>

        <section id="architecture">
            <h2>2. Architecture Diagram</h2>
            <div class="flow-diagram">
<span class="component-box">┌─────────────────────────────────────────────────────────────────────────────────┐</span>
<span class="component-box">│                           BROWSER (Client)                                       │</span>
<span class="component-box">│  ┌─────────────────────────────────────────────────────────────────────────┐   │</span>
<span class="component-box">│  │                     Next.js HMI Application                              │   │</span>
<span class="component-box">│  │                                                                          │   │</span>
<span class="component-box">│  │   ┌──────────────────┐    ┌──────────────────┐    ┌─────────────────┐  │   │</span>
<span class="component-box">│  │   │   RootLayout     │    │  CommandMode     │    │   ToastProvider │  │   │</span>
<span class="component-box">│  │   │   (layout.tsx)   │◄───│   Provider       │    │   (Notifications│  │   │</span>
<span class="component-box">│  │   └────────┬─────────┘    └──────────────────┘    └─────────────────┘  │   │</span>
<span class="component-box">│  │            │                                                            │   │</span>
<span class="component-box">│  │            ▼                                                            │   │</span>
<span class="component-box">│  │   ┌──────────────────────────────────────────────────────────────────┐ │   │</span>
<span class="component-box">│  │   │                    Page Components                                │ │   │</span>
<span class="component-box">│  │   │  ┌─────────┐ ┌──────────┐ ┌────────┐ ┌────────┐ ┌─────────────┐ │ │   │</span>
<span class="component-box">│  │   │  │ / (RTU  │ │ /rtus    │ │/alarms │ │/trends │ │ /control    │ │ │   │</span>
<span class="component-box">│  │   │  │ Status) │ │ (Manage) │ │        │ │        │ │             │ │ │   │</span>
<span class="component-box">│  │   │  └────┬────┘ └────┬─────┘ └───┬────┘ └───┬────┘ └──────┬──────┘ │ │   │</span>
<span class="component-box">│  │   └───────┼───────────┼──────────┼──────────┼────────────┼─────────┘ │   │</span>
<span class="component-box">│  │           │           │          │          │            │           │   │</span>
<span class="component-box">│  │           ▼           ▼          ▼          ▼            ▼           │   │</span>
<span class="component-box">│  │   ┌──────────────────────────────────────────────────────────────────┐ │   │</span>
<span class="component-box">│  │   │                      Custom Hooks                                 │ │   │</span>
<span class="component-box">│  │   │  ┌──────────────────┐    ┌───────────────────────────────────┐  │ │   │</span>
<span class="component-box">│  │   │  │ useRTUStatusData │───▶│        useWebSocket               │  │ │   │</span>
<span class="component-box">│  │   │  │  (Data fetching) │    │  (Real-time subscriptions)        │  │ │   │</span>
<span class="component-box">│  │   │  └────────┬─────────┘    └──────────────┬────────────────────┘  │ │   │</span>
<span class="component-box">│  │   └───────────┼──────────────────────────────┼───────────────────────┘ │   │</span>
<span class="component-box">│  │               │                              │                         │   │</span>
<span class="component-box">│  │               ▼                              ▼                         │   │</span>
<span class="component-box">│  │   ┌───────────────────────────────────────────────────────────────────┐│   │</span>
<span class="component-box">│  │   │                        lib/api.ts                                 ││   │</span>
<span class="component-box">│  │   │   getRTUs() │ getAlarms() │ commandActuator() │ getPIDLoops()     ││   │</span>
<span class="component-box">│  │   └────────────────────────────────┬──────────────────────────────────┘│   │</span>
<span class="component-box">│  └─────────────────────────────────────┼────────────────────────────────────┘   │</span>
<span class="component-box">└───────────────────────────────────────┼─────────────────────────────────────────┘</span>
                                        │
<span class="connection-line">              ══════════════════════════╪══════════════════════════════════════════</span>
<span class="data-flow">                    HTTP/REST :8080     │     WebSocket ws://localhost:8080</span>
<span class="connection-line">              ══════════════════════════╪══════════════════════════════════════════</span>
                                        │
<span class="component-box">┌───────────────────────────────────────┼─────────────────────────────────────────┐</span>
<span class="component-box">│                    Next.js Rewrites   ▼                                         │</span>
<span class="component-box">│  ┌──────────────────────────────────────────────────────────────────────────┐  │</span>
<span class="component-box">│  │  next.config.js                                                          │  │</span>
<span class="component-box">│  │  /api/*  ─────▶  http://localhost:8000/api/*                             │  │</span>
<span class="component-box">│  │  /ws/*   ─────▶  http://localhost:8000/ws/*                              │  │</span>
<span class="component-box">│  │  /health ─────▶  http://localhost:8000/health                            │  │</span>
<span class="component-box">│  └──────────────────────────────────────────────────────────────────────────┘  │</span>
<span class="component-box">└───────────────────────────────────────┬─────────────────────────────────────────┘</span>
                                        │
<span class="connection-line">              ══════════════════════════╪══════════════════════════════════════════</span>
<span class="data-flow">                    Proxy to FastAPI :8000                                        </span>
<span class="connection-line">              ══════════════════════════╪══════════════════════════════════════════</span>
                                        │
<span class="component-box">┌───────────────────────────────────────▼─────────────────────────────────────────┐</span>
<span class="component-box">│                           FastAPI Backend (:8000)                                │</span>
<span class="component-box">│  ┌───────────────────────────────────────────────────────────────────────────┐  │</span>
<span class="component-box">│  │   app/main.py                                                             │  │</span>
<span class="component-box">│  │   ┌─────────────────┐    ┌──────────────────┐    ┌───────────────────┐   │  │</span>
<span class="component-box">│  │   │   /api/v1/*     │    │  /api/v1/ws/live │    │  /health          │   │  │</span>
<span class="component-box">│  │   │   REST Routes   │    │  WebSocket       │    │  Health Check     │   │  │</span>
<span class="component-box">│  │   └────────┬────────┘    └────────┬─────────┘    └───────────────────┘   │  │</span>
<span class="component-box">│  └────────────┼──────────────────────┼───────────────────────────────────────┘  │</span>
<span class="component-box">│               │                      │                                          │</span>
<span class="component-box">│               ▼                      ▼                                          │</span>
<span class="component-box">│  ┌────────────────────────────────────────────────────────────────────────────┐ │</span>
<span class="component-box">│  │   Services Layer                                                           │ │</span>
<span class="component-box">│  │   ┌─────────────────┐   ┌─────────────────┐   ┌────────────────────────┐  │ │</span>
<span class="component-box">│  │   │ profinet_client │   │ rtu_service     │   │ ConnectionManager      │  │ │</span>
<span class="component-box">│  │   │ (Shared Memory) │   │ (RTU Operations)│   │ (WebSocket Broadcast)  │  │ │</span>
<span class="component-box">│  │   └────────┬────────┘   └────────┬────────┘   └────────────────────────┘  │ │</span>
<span class="component-box">│  └────────────┼──────────────────────┼────────────────────────────────────────┘ │</span>
<span class="component-box">│               │                      │                                          │</span>
<span class="component-box">│               ▼                      ▼                                          │</span>
<span class="component-box">│  ┌────────────────────────────────────────────────────────────────────────────┐ │</span>
<span class="component-box">│  │   Persistence Layer (SQLite + SQLAlchemy)                                  │ │</span>
<span class="component-box">│  │   ┌─────────────┐ ┌──────────────┐ ┌─────────────┐ ┌───────────────────┐  │ │</span>
<span class="component-box">│  │   │ RTU Registry│ │ Alarm Store  │ │ Historian   │ │ User/Session      │  │ │</span>
<span class="component-box">│  │   └─────────────┘ └──────────────┘ └─────────────┘ └───────────────────┘  │ │</span>
<span class="component-box">│  └────────────────────────────────────────────────────────────────────────────┘ │</span>
<span class="component-box">└──────────────────────────────────────────────────────────────────────────────────┘</span>
            </div>
        </section>

        <section id="frontend">
            <h2>3. Frontend Structure</h2>
            <div class="card">
                <h3>Directory Layout</h3>
                <pre><code>web/ui/
├── src/
│   ├── app/                    # Next.js 14 App Router
│   │   ├── layout.tsx          # Root layout with navigation
│   │   ├── page.tsx            # Landing page (RTU Status)
│   │   ├── alarms/page.tsx     # Alarm management
│   │   ├── control/page.tsx    # PID control
│   │   ├── io-tags/page.tsx    # I/O tag configuration
│   │   ├── login/page.tsx      # Login page
│   │   ├── modbus/page.tsx     # Modbus gateway config
│   │   ├── network/page.tsx    # Network configuration
│   │   ├── rtus/page.tsx       # RTU management
│   │   ├── rtus/[station_name]/page.tsx  # RTU detail
│   │   ├── settings/page.tsx   # Backup & settings
│   │   ├── system/page.tsx     # System diagnostics
│   │   ├── trends/page.tsx     # Data trending
│   │   ├── users/page.tsx      # User management
│   │   └── wizard/page.tsx     # Setup wizard
│   ├── components/
│   │   ├── hmi/                # ISA-101 HMI components
│   │   │   ├── RTUStatusCard.tsx
│   │   │   ├── AlarmBanner.tsx
│   │   │   ├── ConnectionStatusIndicator.tsx
│   │   │   ├── DataQualityIndicator.tsx
│   │   │   ├── SystemStatusIndicator.tsx
│   │   │   ├── AuthenticationModal.tsx
│   │   │   ├── SessionIndicator.tsx
│   │   │   ├── ControlGuard.tsx
│   │   │   └── DegradedModeBanner.tsx
│   │   └── rtu/                # RTU-specific components
│   ├── contexts/
│   │   └── CommandModeContext.tsx  # Auth context
│   ├── hooks/
│   │   ├── useWebSocket.ts         # WebSocket connection
│   │   ├── useRTUStatusData.ts     # RTU data fetching
│   │   └── useKeyboardShortcuts.ts
│   ├── lib/
│   │   ├── api.ts                  # REST API client
│   │   ├── logger.ts               # Structured logging
│   │   └── exportUtils.ts          # CSV/Excel export
│   └── constants/
│       ├── timing.ts               # Polling intervals
│       ├── quality.ts              # OPC UA quality codes
│       ├── alarm.ts                # Alarm constants
│       └── colors.ts               # ISA-101 colors
├── next.config.js              # API rewrites
├── tailwind.config.js          # ISA-101 color scheme
└── package.json</code></pre>
            </div>
        </section>

        <section id="routing">
            <h2>4. Page Routing</h2>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Route</th>
                            <th>File</th>
                            <th>Purpose</th>
                            <th>Auth Required</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>/</code></td>
                            <td>page.tsx</td>
                            <td>RTU Status Dashboard (landing page)</td>
                            <td><span class="badge badge-green">View</span></td>
                        </tr>
                        <tr>
                            <td><code>/login</code></td>
                            <td>login/page.tsx</td>
                            <td>Authentication page</td>
                            <td><span class="badge badge-green">View</span></td>
                        </tr>
                        <tr>
                            <td><code>/rtus</code></td>
                            <td>rtus/page.tsx</td>
                            <td>RTU inventory management</td>
                            <td><span class="badge badge-yellow">Command*</span></td>
                        </tr>
                        <tr>
                            <td><code>/rtus/[station_name]</code></td>
                            <td>rtus/[station_name]/page.tsx</td>
                            <td>Individual RTU detail</td>
                            <td><span class="badge badge-yellow">Command*</span></td>
                        </tr>
                        <tr>
                            <td><code>/alarms</code></td>
                            <td>alarms/page.tsx</td>
                            <td>Alarm history & acknowledgement</td>
                            <td><span class="badge badge-yellow">Command*</span></td>
                        </tr>
                        <tr>
                            <td><code>/control</code></td>
                            <td>control/page.tsx</td>
                            <td>PID loop & setpoint control</td>
                            <td><span class="badge badge-red">Command</span></td>
                        </tr>
                        <tr>
                            <td><code>/trends</code></td>
                            <td>trends/page.tsx</td>
                            <td>Data trending & export</td>
                            <td><span class="badge badge-green">View</span></td>
                        </tr>
                        <tr>
                            <td><code>/io-tags</code></td>
                            <td>io-tags/page.tsx</td>
                            <td>I/O tag configuration</td>
                            <td><span class="badge badge-red">Admin</span></td>
                        </tr>
                        <tr>
                            <td><code>/modbus</code></td>
                            <td>modbus/page.tsx</td>
                            <td>Modbus gateway config</td>
                            <td><span class="badge badge-red">Admin</span></td>
                        </tr>
                        <tr>
                            <td><code>/network</code></td>
                            <td>network/page.tsx</td>
                            <td>Network settings</td>
                            <td><span class="badge badge-red">Admin</span></td>
                        </tr>
                        <tr>
                            <td><code>/users</code></td>
                            <td>users/page.tsx</td>
                            <td>User account management</td>
                            <td><span class="badge badge-red">Admin</span></td>
                        </tr>
                        <tr>
                            <td><code>/settings</code></td>
                            <td>settings/page.tsx</td>
                            <td>Backup & system settings</td>
                            <td><span class="badge badge-red">Admin</span></td>
                        </tr>
                        <tr>
                            <td><code>/system</code></td>
                            <td>system/page.tsx</td>
                            <td>System status & diagnostics</td>
                            <td><span class="badge badge-green">View</span></td>
                        </tr>
                        <tr>
                            <td><code>/wizard</code></td>
                            <td>wizard/page.tsx</td>
                            <td>Initial setup wizard</td>
                            <td><span class="badge badge-red">Admin</span></td>
                        </tr>
                    </tbody>
                </table>
                <p><small>* Command mode required for write operations only</small></p>
            </div>
        </section>

        <section id="components">
            <h2>5. Component Hierarchy</h2>
            <div class="card">
                <h3>Root Layout Structure</h3>
                <pre><code>RootLayout (layout.tsx)
├── CommandModeProvider        # Authentication context
│   └── ToastProvider          # Notification system
│       └── LayoutContent
│           ├── Skip Link (accessibility)
│           ├── CommandModeBanner    # Shows when in command mode
│           ├── DegradedModeBanner   # Shows when WebSocket disconnected
│           ├── Header
│           │   ├── Logo & Branding
│           │   ├── NavLinks
│           │   │   ├── RTUs (/)
│           │   │   ├── Manage (/rtus)
│           │   │   ├── Alarms (/alarms)
│           │   │   ├── Trends (/trends)
│           │   │   └── Control (/control)
│           │   ├── Configuration Dropdown
│           │   │   ├── I/O Tags
│           │   │   ├── Modbus Gateway
│           │   │   ├── Network
│           │   │   ├── Users
│           │   │   └── Backup & Settings
│           │   ├── System (/system)
│           │   ├── SystemStatusIndicator (compact)
│           │   └── SessionIndicator
│           ├── Main Content (children pages)
│           ├── Footer
│           └── AuthenticationModal</code></pre>

                <h3>Landing Page Component Tree (RTU Status)</h3>
                <pre><code>RTUStatusPage (page.tsx)
├── useRTUStatusData()         # Data fetching hook
│   ├── getRTUs()              # API: /api/v1/rtus
│   ├── getAlarms()            # API: /api/v1/alarms
│   ├── getRTUInventory()      # API: /api/v1/rtus/{name}/inventory
│   └── useWebSocket()         # Subscribe to events
│       ├── 'rtu_update'
│       ├── 'alarm_raised'
│       ├── 'alarm_acknowledged'
│       └── 'alarm_cleared'
├── AlarmBanner                # Active alarms display
│   ├── Alarm count
│   ├── Acknowledge button
│   └── Acknowledge all button
├── Page Header
│   ├── Title ("RTU Status")
│   └── Quick Stats
│       ├── RTUs Online count
│       ├── Active Alarms count
│       └── ConnectionStatusIndicator
├── RTU Grid
│   └── RTUStatusCard[] (for each RTU)
│       ├── ConnectionStatusIndicator
│       ├── DataQualityIndicator
│       ├── Sensor count
│       ├── Actuator count
│       └── Link to /rtus/{station_name}
├── Data Mode Indicator
│   ├── "polling" warning
│   └── "disconnected" error
└── SystemStatusBar
    ├── PROFINET status
    ├── WebSocket status
    ├── Cycle time metrics
    └── Pending writes counter</code></pre>
            </div>
        </section>

        <section id="data-flow">
            <h2>6. Data Flow & State Management</h2>
            <div class="grid-2">
                <div class="card">
                    <h3>React Context (Global State)</h3>
                    <h4>CommandModeContext</h4>
                    <pre><code>interface CommandModeContextType {
  mode: 'view' | 'command';
  user: User | null;
  timeRemaining: number | null;
  isAuthenticated: boolean;
  canCommand: boolean;
  enterCommandMode: (username, password) =&gt; Promise&lt;boolean&gt;;
  exitCommandMode: () =&gt; void;
  extendTimeout: () =&gt; void;
}</code></pre>
                    <p>5-minute timeout for command mode with auto-logout.</p>
                </div>

                <div class="card">
                    <h3>Custom Hooks</h3>
                    <h4>useRTUStatusData</h4>
                    <ul>
                        <li>Fetches RTU and alarm data on mount</li>
                        <li>Subscribes to WebSocket events</li>
                        <li>Falls back to 5s polling if WebSocket disconnects</li>
                        <li>Tab visibility awareness (pauses when hidden)</li>
                    </ul>

                    <h4>useWebSocket</h4>
                    <ul>
                        <li>Auto-reconnection with exponential backoff</li>
                        <li>Event-based pub/sub pattern</li>
                        <li>Wildcard subscriber support (*)</li>
                        <li>Connection state tracking</li>
                    </ul>
                </div>
            </div>

            <div class="card">
                <h3>Data Quality Tracking (OPC UA)</h3>
                <table>
                    <tr>
                        <th>Quality Code</th>
                        <th>Hex</th>
                        <th>Display</th>
                        <th>Color</th>
                    </tr>
                    <tr>
                        <td>QUALITY_GOOD</td>
                        <td><code>0x00</code></td>
                        <td>Normal operation</td>
                        <td class="status-ok">Gray (normal)</td>
                    </tr>
                    <tr>
                        <td>QUALITY_UNCERTAIN</td>
                        <td><code>0x40</code></td>
                        <td>Data may be stale</td>
                        <td class="status-warn">Yellow</td>
                    </tr>
                    <tr>
                        <td>QUALITY_BAD</td>
                        <td><code>0x80</code></td>
                        <td>Sensor error</td>
                        <td class="status-error">Red</td>
                    </tr>
                    <tr>
                        <td>QUALITY_NOT_CONNECTED</td>
                        <td><code>0xC0</code></td>
                        <td>No communication</td>
                        <td class="status-error">Red (crossed)</td>
                    </tr>
                </table>
            </div>
        </section>

        <section id="api">
            <h2>7. API Endpoints</h2>
            <div class="card">
                <h3>API Base Configuration</h3>
                <pre><code>// next.config.js rewrites
/api/:path*  →  http://localhost:8000/api/:path*
/ws/:path*   →  http://localhost:8000/ws/:path*
/health      →  http://localhost:8000/health</code></pre>

                <h3>RTU Management</h3>
                <table>
                    <tr><th>Method</th><th>Endpoint</th><th>Description</th></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/rtus</code></td><td>List all RTUs</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/rtus/{station_name}</code></td><td>Get RTU details</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/rtus/{station_name}/sensors</code></td><td>Get sensor values</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/rtus/{station_name}/actuators/{slot}</code></td><td>Command actuator</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/rtus/{station_name}/inventory</code></td><td>Get RTU inventory</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/rtus/{station_name}/inventory/refresh</code></td><td>Refresh inventory</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/rtus/{station_name}/pid</code></td><td>Get PID loops</td></tr>
                </table>

                <h3>Alarm Management</h3>
                <table>
                    <tr><th>Method</th><th>Endpoint</th><th>Description</th></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/alarms</code></td><td>List active alarms</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/alarms/history</code></td><td>Alarm history</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/alarms/{id}/acknowledge</code></td><td>Acknowledge alarm</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/alarms/acknowledge-all</code></td><td>Acknowledge all</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/alarms/shelved</code></td><td>Get shelved alarms</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/alarms/shelve</code></td><td>Shelve alarm</td></tr>
                    <tr><td><span class="badge badge-red">DELETE</span></td><td><code>/api/v1/alarms/shelved/{shelf_id}</code></td><td>Unshelve alarm</td></tr>
                </table>

                <h3>Control (PID)</h3>
                <table>
                    <tr><th>Method</th><th>Endpoint</th><th>Description</th></tr>
                    <tr><td><span class="badge badge-purple">PUT</span></td><td><code>/api/v1/rtus/{station_name}/pid/{loop_id}/setpoint</code></td><td>Set setpoint</td></tr>
                    <tr><td><span class="badge badge-purple">PUT</span></td><td><code>/api/v1/rtus/{station_name}/pid/{loop_id}/mode</code></td><td>Set mode (AUTO/MANUAL/CASCADE)</td></tr>
                    <tr><td><span class="badge badge-purple">PUT</span></td><td><code>/api/v1/rtus/{station_name}/pid/{loop_id}/tuning</code></td><td>Set PID tuning (Kp, Ki, Kd)</td></tr>
                </table>

                <h3>Authentication</h3>
                <table>
                    <tr><th>Method</th><th>Endpoint</th><th>Description</th></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/auth/login</code></td><td>User login (returns token)</td></tr>
                </table>

                <h3>System</h3>
                <table>
                    <tr><th>Method</th><th>Endpoint</th><th>Description</th></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/api/v1/system/status</code></td><td>System health metrics</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/system/</code></td><td>Create backup</td></tr>
                    <tr><td><span class="badge badge-blue">POST</span></td><td><code>/api/v1/system/restore</code></td><td>Restore backup</td></tr>
                    <tr><td><span class="badge badge-green">GET</span></td><td><code>/health</code></td><td>Health check endpoint</td></tr>
                </table>
            </div>
        </section>

        <section id="websocket">
            <h2>8. WebSocket Events</h2>
            <div class="card">
                <h3>Connection Endpoint</h3>
                <pre><code>WebSocket URL: ws://localhost:8080/api/v1/ws/live
                (proxied to ws://localhost:8000/api/v1/ws/live)</code></pre>

                <h3>Message Format</h3>
                <pre><code>{
  "channel": "rtu_update",     // or "type" (frontend compat)
  "data": { ... },             // Event payload
  "timestamp": "2025-12-31T00:00:00Z",
  "rtu": "pump-station-1"      // Optional RTU filter
}</code></pre>

                <h3>Event Types</h3>
                <table>
                    <tr><th>Event</th><th>Description</th><th>Data Payload</th></tr>
                    <tr>
                        <td><code>rtu_update</code></td>
                        <td>RTU connection state changed</td>
                        <td>{ previous_state, new_state }</td>
                    </tr>
                    <tr>
                        <td><code>sensor_update</code></td>
                        <td>Sensor value changed</td>
                        <td>{ station_name, slot, value, quality }</td>
                    </tr>
                    <tr>
                        <td><code>actuator_command</code></td>
                        <td>Actuator command sent</td>
                        <td>{ station_name, slot, command }</td>
                    </tr>
                    <tr>
                        <td><code>alarm_raised</code></td>
                        <td>New alarm activated</td>
                        <td>{ alarm_id, rtu_station, severity, message }</td>
                    </tr>
                    <tr>
                        <td><code>alarm_acknowledged</code></td>
                        <td>Alarm acknowledged by operator</td>
                        <td>{ alarm_id, ack_user, ack_time }</td>
                    </tr>
                    <tr>
                        <td><code>alarm_cleared</code></td>
                        <td>Alarm condition cleared</td>
                        <td>{ alarm_id, clear_time }</td>
                    </tr>
                    <tr>
                        <td><code>pid_update</code></td>
                        <td>PID loop values changed</td>
                        <td>{ loop_id, pv, cv, setpoint }</td>
                    </tr>
                    <tr>
                        <td><code>discovery_complete</code></td>
                        <td>Sensor discovery finished</td>
                        <td>{ devices_found }</td>
                    </tr>
                    <tr>
                        <td><code>network_scan_complete</code></td>
                        <td>Network scan finished</td>
                        <td>{ scan_results }</td>
                    </tr>
                </table>

                <h3>Subscription Protocol</h3>
                <pre><code>// Client sends subscription request
{
  "action": "subscribe",
  "channels": ["sensors", "controls", "alarms", "rtu_state"],
  "rtus": ["pump-station-1"]  // Optional filter
}

// Server confirms
{
  "type": "subscribed",
  "channels": ["sensors", "controls", "alarms", "rtu_state"],
  "rtus": "all"
}

// Heartbeat (every 30s)
Client: { "type": "ping" }
Server: { "type": "pong" }</code></pre>
            </div>
        </section>

        <section id="auth">
            <h2>9. Authentication Flow</h2>
            <div class="card">
                <h3>Login Request</h3>
                <pre><code>POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "operator",
  "password": "password123"
}

// Response
{
  "username": "operator",
  "role": "operator",  // or "admin"
  "token": "eyJhbGciOiJIUzI1NiIs..."
}</code></pre>

                <h3>Command Mode Flow</h3>
                <ol>
                    <li>User clicks "Login" in SessionIndicator</li>
                    <li>AuthenticationModal opens</li>
                    <li>User enters credentials</li>
                    <li>enterCommandMode() calls /api/v1/auth/login</li>
                    <li>On success, token stored in memory (lib/api.ts)</li>
                    <li>CommandModeBanner shows with countdown (5 min)</li>
                    <li>All subsequent API requests include Authorization header</li>
                    <li>After 5 minutes (or logout), token cleared</li>
                </ol>

                <h3>Token Storage</h3>
                <pre><code>// lib/api.ts - In-memory storage (cleared on refresh)
let authToken: string | null = null;

export function setAuthToken(token: string | null): void {
  authToken = token;
}

// Added to all requests
if (authToken) {
  headers['Authorization'] = `Bearer ${authToken}`;
}</code></pre>
            </div>
        </section>

        <section id="config">
            <h2>10. Configuration</h2>
            <div class="grid-2">
                <div class="card">
                    <h3>next.config.js</h3>
                    <pre><code>const apiUrl = process.env.API_URL
  || 'http://localhost:8000';

module.exports = {
  reactStrictMode: false,
  async rewrites() {
    return [
      { source: '/api/:path*',
        destination: `${apiUrl}/api/:path*` },
      { source: '/ws/:path*',
        destination: `${apiUrl}/ws/:path*` },
      { source: '/health',
        destination: `${apiUrl}/health` },
    ];
  },
};</code></pre>
                </div>

                <div class="card">
                    <h3>Timing Constants</h3>
                    <pre><code>TIMING = {
  POLLING: {
    FAST: 1000,      // Real-time
    NORMAL: 5000,    // Standard
    SLOW: 30000,     // Background
    VERY_SLOW: 60000
  },
  STALE_THRESHOLDS: {
    WARNING_MS: 5000,
    CRITICAL_MS: 30000
  },
  WEBSOCKET: {
    RECONNECT_INTERVAL_MS: 3000,
    MAX_RECONNECT_ATTEMPTS: 10
  },
  SESSION: {
    COMMAND_MODE_MS: 5 * 60 * 1000  // 5 min
  }
};</code></pre>
                </div>
            </div>

            <div class="card">
                <h3>Environment Variables</h3>
                <table>
                    <tr><th>Variable</th><th>Default</th><th>Description</th></tr>
                    <tr>
                        <td><code>API_URL</code></td>
                        <td>http://localhost:8000</td>
                        <td>Backend API URL (for rewrites)</td>
                    </tr>
                    <tr>
                        <td><code>NEXT_PUBLIC_API_URL</code></td>
                        <td>(empty)</td>
                        <td>Client-side API base (usually not needed)</td>
                    </tr>
                    <tr>
                        <td><code>NEXT_PUBLIC_WS_URL</code></td>
                        <td>ws://localhost:8000/ws</td>
                        <td>WebSocket URL</td>
                    </tr>
                    <tr>
                        <td><code>NEXT_PUBLIC_ENABLE_MOCKS</code></td>
                        <td>false</td>
                        <td>Enable mock data for development</td>
                    </tr>
                </table>
            </div>
        </section>

        <section id="html-output">
            <h2>11. HTML Output Sample</h2>
            <div class="card">
                <p>The following is the actual HTML rendered by the Next.js HMI when loaded in a browser:</p>
                <h3>Key HTML Structure</h3>
                <pre><code>&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;title&gt;Water Treatment Controller - HMI&lt;/title&gt;
  &lt;meta name="description" content="SCADA HMI for Water Treatment RTU Network"/&gt;
  &lt;link rel="icon" href="/favicon.svg" type="image/svg+xml"/&gt;
  &lt;link href="https://fonts.googleapis.com/css2?family=Inter..." rel="stylesheet"/&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="min-h-screen flex flex-col"&gt;

    &lt;!-- Skip to main content (accessibility) --&gt;
    &lt;a href="#main-content" class="sr-only focus:not-sr-only..."&gt;
      Skip to main content
    &lt;/a&gt;

    &lt;!-- Degraded Mode Banner (when WebSocket disconnected) --&gt;
    &lt;div class="bg-alarm-yellow animate-pulse" role="alert"&gt;
      &lt;span class="font-semibold"&gt;Real-Time Updates Unavailable&lt;/span&gt;
      &lt;span&gt;Falling back to polling mode. Data updates may be delayed.&lt;/span&gt;
    &lt;/div&gt;

    &lt;!-- Header with Navigation --&gt;
    &lt;header class="sticky top-0 z-50 bg-slate-900/95 backdrop-blur-lg"&gt;
      &lt;div class="flex items-center justify-between"&gt;
        &lt;!-- Logo --&gt;
        &lt;a href="/" class="flex items-center gap-3"&gt;
          &lt;div class="w-10 h-10 rounded-lg bg-gradient-to-br from-sky-400 to-blue-600"&gt;
            &lt;svg&gt;...flask icon...&lt;/svg&gt;
          &lt;/div&gt;
          &lt;h1&gt;Water Treatment Controller&lt;/h1&gt;
          &lt;span&gt;SCADA/HMI v1.0.0&lt;/span&gt;
        &lt;/a&gt;

        &lt;!-- Navigation --&gt;
        &lt;nav&gt;
          &lt;a href="/" class="active"&gt;RTUs&lt;/a&gt;
          &lt;a href="/rtus"&gt;Manage&lt;/a&gt;
          &lt;a href="/alarms"&gt;Alarms&lt;/a&gt;
          &lt;a href="/trends"&gt;Trends&lt;/a&gt;
          &lt;a href="/control"&gt;Control&lt;/a&gt;
          &lt;button&gt;Configuration ▼&lt;/button&gt;
          &lt;a href="/system"&gt;System&lt;/a&gt;
          &lt;!-- SystemStatusIndicator --&gt;
          &lt;div class="bg-yellow-100 text-yellow-600"&gt;Connecting...&lt;/div&gt;
          &lt;!-- SessionIndicator --&gt;
          &lt;div&gt;View Mode | &lt;button&gt;Login →&lt;/button&gt;&lt;/div&gt;
        &lt;/nav&gt;
      &lt;/div&gt;
    &lt;/header&gt;

    &lt;!-- Main Content --&gt;
    &lt;main id="main-content" class="flex-1 p-6"&gt;
      &lt;!-- Loading state (while fetching RTU data) --&gt;
      &lt;div class="min-h-screen bg-hmi-bg flex items-center justify-center"&gt;
        &lt;div class="w-12 h-12 border-4 border-alarm-blue animate-spin"&gt;&lt;/div&gt;
        &lt;div&gt;Loading RTU Status...&lt;/div&gt;
      &lt;/div&gt;

      &lt;!-- Once loaded, shows:
        - AlarmBanner (if alarms exist)
        - Page Header with stats
        - RTU Grid with RTUStatusCard components
        - SystemStatusBar
      --&gt;
    &lt;/main&gt;

    &lt;!-- Footer --&gt;
    &lt;footer class="border-t border-slate-800/50 py-4 px-6"&gt;
      &lt;span&gt;Water Treatment Controller SCADA/HMI&lt;/span&gt;
      &lt;span&gt;PROFINET I/O Controller - Browser Configuration&lt;/span&gt;
    &lt;/footer&gt;

  &lt;/div&gt;

  &lt;!-- Toast notification container --&gt;
  &lt;div class="fixed bottom-4 right-4 z-50"&gt;&lt;/div&gt;

&lt;/body&gt;
&lt;/html&gt;</code></pre>
            </div>
        </section>

        <section id="deployment">
            <h2>12. Production Deployment (After install.sh)</h2>
            <div class="card">
                <h3>Systemd Services</h3>
                <p>After running <code>install.sh</code>, two systemd services are created:</p>
                <table>
                    <tr>
                        <th>Service</th>
                        <th>Port</th>
                        <th>Description</th>
                        <th>Command</th>
                    </tr>
                    <tr>
                        <td><code>water-controller.service</code></td>
                        <td>8000</td>
                        <td>FastAPI Backend (uvicorn)</td>
                        <td><code>systemctl status water-controller</code></td>
                    </tr>
                    <tr>
                        <td><code>water-controller-frontend.service</code></td>
                        <td>8080</td>
                        <td>Next.js HMI (next start)</td>
                        <td><code>systemctl status water-controller-frontend</code></td>
                    </tr>
                </table>

                <h3>Installation Paths</h3>
                <table>
                    <tr><th>Path</th><th>Description</th></tr>
                    <tr><td><code>/opt/water-controller/</code></td><td>Main installation directory</td></tr>
                    <tr><td><code>/opt/water-controller/venv/</code></td><td>Python virtual environment</td></tr>
                    <tr><td><code>/opt/water-controller/app/</code></td><td>FastAPI application</td></tr>
                    <tr><td><code>/opt/water-controller/web/</code></td><td>Next.js frontend (with .next build)</td></tr>
                    <tr><td><code>/etc/water-controller/</code></td><td>Configuration files</td></tr>
                    <tr><td><code>/var/lib/water-controller/</code></td><td>Data directory (SQLite DB)</td></tr>
                    <tr><td><code>/var/log/water-controller/</code></td><td>Log files</td></tr>
                </table>

                <h3>Service Startup Commands</h3>
                <pre><code># Backend API (FastAPI/uvicorn)
ExecStart=/opt/water-controller/venv/bin/uvicorn app.main:app \
    --host 0.0.0.0 --port 8000 --workers 2

# Frontend HMI (Next.js)
ExecStart=/usr/bin/node /opt/water-controller/web/node_modules/.bin/next start \
    -p 8080 -H 0.0.0.0</code></pre>

                <h3>Service Dependencies</h3>
                <div class="flow-diagram">
<span class="component-box">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="component-box">│                       System Boot                                │</span>
<span class="component-box">└────────────────────────────┬────────────────────────────────────┘</span>
                             │
                             ▼
<span class="component-box">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="component-box">│                  network-online.target                          │</span>
<span class="component-box">└────────────────────────────┬────────────────────────────────────┘</span>
                             │
                             ▼
<span class="component-box">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="component-box">│               water-controller.service                          │</span>
<span class="component-box">│               (Backend API on :8000)                            │</span>
<span class="component-box">└────────────────────────────┬────────────────────────────────────┘</span>
                             │
                             ▼
<span class="component-box">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="component-box">│          water-controller-frontend.service                      │</span>
<span class="component-box">│          (Next.js HMI on :8080)                                 │</span>
<span class="component-box">│          BindsTo=water-controller.service                       │</span>
<span class="component-box">└─────────────────────────────────────────────────────────────────┘</span>
                </div>
                <p><strong>Note:</strong> Frontend service is bound to backend - if backend stops, frontend stops too.</p>

                <h3>Quick Check Commands</h3>
                <pre><code># Check both services
systemctl status water-controller water-controller-frontend

# View logs
journalctl -u water-controller -f
journalctl -u water-controller-frontend -f

# Restart both services
systemctl restart water-controller water-controller-frontend

# Check if ports are listening
ss -tlnp | grep -E '8000|8080'</code></pre>
            </div>
        </section>

        <section>
            <h2>13. Troubleshooting</h2>
            <div class="card">
                <h3>HMI Shows "Loading..." Indefinitely</h3>
                <table>
                    <tr><th>Symptom</th><th>Cause</th><th>Solution</th></tr>
                    <tr>
                        <td>Spinner never stops</td>
                        <td>Backend API not running</td>
                        <td>Start FastAPI: <code>cd web/api && python -m uvicorn app.main:app --port 8000</code></td>
                    </tr>
                    <tr>
                        <td>"Degraded Mode" banner</td>
                        <td>WebSocket can't connect</td>
                        <td>Normal if backend down; check /api/v1/ws/live endpoint</td>
                    </tr>
                    <tr>
                        <td>"Connection Error" screen</td>
                        <td>API unreachable</td>
                        <td>Check backend is on port 8000, verify rewrites in next.config.js</td>
                    </tr>
                    <tr>
                        <td>No node_modules</td>
                        <td>Dependencies not installed</td>
                        <td><code>cd web/ui && npm install</code></td>
                    </tr>
                    <tr>
                        <td>No .next folder</td>
                        <td>App not built</td>
                        <td><code>npm run build</code> or <code>npm run dev</code></td>
                    </tr>
                </table>
            </div>
        </section>

        <footer style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--border); text-align: center; color: var(--text-secondary);">
            <p>Water Treatment Controller - Next.js HMI Wiring Audit</p>
            <p>Generated: December 31, 2025</p>
        </footer>
    </div>
</body>
</html>
