# ============================================================================
# Deploy Workflow - Automatic Deployment on Push to Main
# ============================================================================
# Purpose: Deploy the application to the self-hosted runner when code is pushed
#
# Triggers:
#   - Push to main branch
#   - Manual dispatch (workflow_dispatch)
#
# Requirements:
#   - Self-hosted runner with labels: self-hosted, Linux, X64
#   - Runner user must have sudo access for docker operations
# ============================================================================

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Deployment mode'
        required: false
        default: 'docker'
        type: choice
        options:
          - docker
          - baremetal
      action:
        description: 'Bootstrap action'
        required: false
        default: 'fresh'
        type: choice
        options:
          - fresh
          - upgrade
          - reinstall

# Only one deployment at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Server
    runs-on: [self-hosted, Linux, X64]
    timeout-minutes: 30

    steps:
      - name: Pre-deployment info
        run: |
          echo "=== Deployment Info ==="
          echo "Triggered by: ${{ github.event_name }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Runner: $(hostname)"
          echo "User: $(whoami)"
          echo "Date: $(date)"
          echo "======================="

      - name: Run bootstrap deployment
        run: |
          curl -fsSL https://raw.githubusercontent.com/mwilco03/Water-Controller/main/bootstrap.sh | sudo bash -s -- ${{ inputs.action || 'fresh' }} --mode ${{ inputs.mode || 'docker' }}

      - name: Verify deployment
        run: |
          echo "=== Verifying Deployment ==="

          # Wait for services to start
          sleep 10

          # Check Docker containers
          echo "Docker containers:"
          docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true

          # Check API health
          echo ""
          echo "API health check:"
          curl -sf http://localhost:8000/health || echo "API not responding yet (may still be starting)"

          # Check UI
          echo ""
          echo "UI health check:"
          curl -sf http://localhost:8080 -o /dev/null && echo "UI is responding" || echo "UI not responding yet"

      - name: Post-deployment summary
        if: always()
        run: |
          echo "=== Deployment Complete ==="
          echo "Commit ${{ github.sha }} deployed"
          echo "View logs: docker logs wtc-api -f"
          echo "==========================="
