# ============================================================================
# CI Workflow - Continuous Integration
# ============================================================================
# Purpose: Build, test, and validate code quality on every push and PR
#
# Jobs (consolidated to reduce check noise):
#   - quality-c          - cppcheck + build + tests (~4 min)
#   - quality-python     - ruff + mypy + pytest + pip-audit (~3 min)
#   - quality-typescript - eslint + jest + next build + npm audit (~4 min)
#   - build-arm          - Cross-compilation (main/release only)
#
# Optimizations:
#   - Concurrency: Cancels in-progress runs when new commits are pushed
#   - Path filtering: Jobs only run when relevant files change
#   - Artifacts: Only uploaded on main/develop branches
# ============================================================================

name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release

jobs:
  # ============================================================================
  # Detect which files changed (for path filtering)
  # ============================================================================
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      c: ${{ steps.filter.outputs.c }}
      python: ${{ steps.filter.outputs.python }}
      typescript: ${{ steps.filter.outputs.typescript }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            c:
              - 'src/**'
              - 'CMakeLists.txt'
              - 'cmake/**'
              - '.github/workflows/ci.yml'
            python:
              - 'web/api/**'
              - '.github/workflows/ci.yml'
            typescript:
              - 'web/ui/**'
              - '.github/workflows/ci.yml'

  # ============================================================================
  # C Quality - Static analysis, build, and tests (single job)
  # ============================================================================
  quality-c:
    name: C (cppcheck + build + test)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.c == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Cache apt packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: build-essential cmake pkg-config libpq-dev libjson-c-dev libsqlite3-dev libcurl4-openssl-dev cppcheck
          version: 1.0-x86_64

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake pkg-config libpq-dev libjson-c-dev libsqlite3-dev libcurl4-openssl-dev cppcheck

      - name: Static analysis (cppcheck)
        run: |
          cppcheck \
            --enable=warning,style,performance,portability \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --error-exitcode=1 \
            src/

      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: build
          key: cmake-x86_64-${{ hashFiles('CMakeLists.txt', 'src/**/*.c', 'src/**/*.h', 'cmake/**') }}
          restore-keys: cmake-x86_64-

      - name: Build
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DBUILD_TESTS=ON
          cmake --build build --parallel $(nproc)

      - name: Test
        run: cd build && ctest --output-on-failure

      - name: Upload artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-x86_64
          path: build/water_treat_controller
          retention-days: 7

  # ============================================================================
  # Python Quality - Lint and test in single job (one pip install)
  # ============================================================================
  quality-python:
    name: Python (ruff + mypy + pytest)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.python == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: web/api/requirements*.txt

      - name: Install dependencies
        run: |
          pip install -r web/api/requirements.txt
          pip install mypy ruff pytest-cov types-psutil pip-audit

      - name: Lint (ruff)
        run: cd web/api && ruff check . --output-format=github

      - name: Type check (mypy)
        run: cd web/api && mypy app/ --ignore-missing-imports || true

      - name: Test (pytest)
        run: |
          cd web/api
          pytest tests/ --cov=app --cov-report=term-missing -v || true

      - name: Security audit (pip-audit)
        run: pip-audit -r web/api/requirements.txt || true

  # ============================================================================
  # TypeScript Quality - Lint, test, build in single job (one npm ci)
  # ============================================================================
  quality-typescript:
    name: TypeScript (eslint + jest + build)
    runs-on: ubuntu-latest
    needs: changes
    if: needs.changes.outputs.typescript == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/ui/package-lock.json

      - name: Install dependencies
        run: cd web/ui && npm ci

      - name: Lint (ESLint)
        run: cd web/ui && npm run lint

      - name: Test (Jest)
        run: cd web/ui && npm run test:coverage -- --passWithNoTests --ci || true

      - name: Build (Next.js)
        run: cd web/ui && npm run build

      - name: Security audit (npm audit)
        run: cd web/ui && npm audit --audit-level=high || true

      - name: Upload artifact
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-web-ui
          path: |
            web/ui/.next
            web/ui/public
            web/ui/package.json
          retention-days: 7

  # ============================================================================
  # ARM Cross-Compilation (main/release only, after C quality passes)
  # ============================================================================
  build-arm:
    name: ARM (${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [changes, quality-c]
    if: |
      github.event_name == 'push' &&
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop') &&
      needs.changes.outputs.c == 'true'

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: aarch64
            toolchain: cmake/toolchain-aarch64.cmake
            packages: "cmake pkg-config gcc-aarch64-linux-gnu g++-aarch64-linux-gnu"
            extra_flags: ""
          - arch: armv7hf
            toolchain: cmake/toolchain-arm.cmake
            packages: "cmake pkg-config gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf"
            extra_flags: ""
          - arch: armv6
            toolchain: cmake/toolchain-arm.cmake
            packages: "cmake pkg-config gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf"
            extra_flags: "-DARM_ARCH=armv6"

    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.packages }}

      - name: Build
        run: |
          cmake -B build-${{ matrix.arch }} \
            -DCMAKE_TOOLCHAIN_FILE=${{ matrix.toolchain }} \
            ${{ matrix.extra_flags }} \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=OFF
          cmake --build build-${{ matrix.arch }} --parallel $(nproc)

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-${{ matrix.arch }}
          path: build-${{ matrix.arch }}/water_treat_controller
          retention-days: 7
