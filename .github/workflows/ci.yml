name: CI Build

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

env:
  BUILD_TYPE: Release

jobs:
  build-native:
    name: Build x86_64 (Native)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libpq-dev libjson-c-dev \
            libsqlite3-dev libcurl4-openssl-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Run Tests
        run: cd build && ctest --output-on-failure

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-x86_64
          path: build/water_treat_controller

  build-arm64:
    name: Build ARM64 (aarch64)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake pkg-config \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain-aarch64.cmake \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=OFF

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-aarch64
          path: build/water_treat_controller

  build-armhf:
    name: Build ARM32 (armhf)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake pkg-config \
            gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=cmake/toolchain-arm.cmake \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=OFF

      - name: Build
        run: cmake --build build --parallel $(nproc)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-armhf
          path: build/water_treat_controller

  static-analysis:
    name: Static Analysis (cppcheck)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install cppcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --enable=all \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --error-exitcode=0 \
            --xml --xml-version=2 \
            --output-file=cppcheck-report.xml \
            src/ 2>&1 | tee cppcheck-output.txt

      - name: Generate HTML report
        run: |
          sudo apt-get install -y cppcheck-htmlreport || true
          if command -v cppcheck-htmlreport &> /dev/null; then
            cppcheck-htmlreport --file=cppcheck-report.xml --report-dir=cppcheck-html
          fi

      - name: Upload cppcheck report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: |
            cppcheck-report.xml
            cppcheck-output.txt
            cppcheck-html/

  format-check:
    name: Format Check (clang-format)
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking

    steps:
      - uses: actions/checkout@v4

      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format

      - name: Check formatting
        run: |
          find src/ -name '*.c' -o -name '*.h' | \
            xargs clang-format --dry-run --Werror 2>&1 | tee format-check.txt || true

          # Count formatting issues
          ISSUES=$(grep -c "error:" format-check.txt || echo "0")
          echo "Found $ISSUES formatting issues"

          if [ "$ISSUES" -gt 0 ]; then
            echo "::warning::Found $ISSUES files with formatting issues. Run 'clang-format -i' to fix."
          fi

      - name: Upload format check results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: format-check-results
          path: format-check.txt
