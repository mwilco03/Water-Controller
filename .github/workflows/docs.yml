# ============================================================================
# Documentation Workflow - Generate, Validate, and Deploy Documentation
# ============================================================================
# Purpose: Maintain documentation quality and generate API references
#
# Jobs (consolidated to reduce check noise):
#   - validate-and-generate : Validate docs + generate API docs (PRs/push)
#   - deploy-pages          : Deploy to GitHub Pages (on release only)
#   - health-check          : Weekly staleness check (scheduled)
# ============================================================================

name: Documentation

on:
  push:
    branches:
      - main
      - master
      - develop
    paths:
      - 'docs/**'
      - 'web/api/**'
      - 'src/**/*.h'
      - 'README.md'
      - 'CHANGELOG.md'
      - '.github/workflows/docs.yml'

  pull_request:
    branches:
      - main
      - master
    paths:
      - 'docs/**'
      - 'README.md'

  release:
    types: [published]

  workflow_dispatch:
    inputs:
      deploy:
        description: 'Deploy to GitHub Pages'
        required: false
        default: 'false'
        type: boolean
      version:
        description: 'Version for snapshot (e.g., v1.0.0)'
        required: false
        type: string

  schedule:
    # Weekly on Monday at 9am UTC - check for stale documentation
    - cron: '0 9 * * 1'

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # Validate and Generate Documentation (consolidated job for PRs/push)
  # ============================================================================
  validate-and-generate:
    name: Validate & Generate Docs
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: web/api/requirements.txt

      - name: Install Doxygen
        run: |
          sudo apt-get update
          sudo apt-get install -y doxygen graphviz

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check

      # --- Validate markdown links ---
      - name: Check markdown links
        run: |
          echo "Checking markdown links..."
          find . -name '*.md' -not -path './node_modules/*' -not -path './.git/*' | while read file; do
            echo "Checking: $file"
            markdown-link-check "$file" --config .github/markdown-link-check.json 2>&1 || true
          done

      - name: Check for common documentation issues
        run: |
          echo "=== Checking for placeholder content ==="
          grep -rn "TODO\|FIXME\|TBD\|XXX\|PLACEHOLDER" docs/ README.md 2>/dev/null || echo "No placeholders found"

          echo ""
          echo "=== Documentation files found ==="
          find . -name '*.md' -not -path './node_modules/*' -not -path './.git/*' | wc -l
          echo "markdown files"

      # --- Generate OpenAPI spec ---
      - name: Install Python dependencies
        run: |
          cd web/api
          pip install -r requirements.txt
          pip install pyyaml

      - name: Generate OpenAPI spec
        run: |
          cd web/api

          cat > export_openapi.py << 'EOF'
          import json
          import yaml
          import sys
          sys.path.insert(0, '.')

          try:
              from main import app
              openapi_schema = app.openapi()
              with open('openapi.json', 'w') as f:
                  json.dump(openapi_schema, f, indent=2)
              with open('openapi.yaml', 'w') as f:
                  yaml.dump(openapi_schema, f, default_flow_style=False, sort_keys=False)
              print(f"Generated OpenAPI spec version: {openapi_schema.get('openapi', 'unknown')}")
              print(f"Endpoints documented: {len(openapi_schema.get('paths', {}))}")
          except Exception as e:
              print(f"Warning: Could not generate OpenAPI spec: {e}")
              placeholder = {"openapi": "3.0.0", "info": {"title": "Water-Controller API", "version": "0.0.1"}, "paths": {}}
              with open('openapi.json', 'w') as f:
                  json.dump(placeholder, f, indent=2)
              with open('openapi.yaml', 'w') as f:
                  yaml.dump(placeholder, f)
          EOF

          python export_openapi.py || echo "OpenAPI generation completed with warnings"
          mkdir -p ../../docs/generated/api
          cp openapi.json openapi.yaml ../../docs/generated/api/ 2>/dev/null || true

      # --- Generate C API docs with Doxygen ---
      - name: Create Doxyfile
        run: |
          cat > Doxyfile << 'EOF'
          PROJECT_NAME           = "Water-Controller"
          PROJECT_NUMBER         = "0.1.0"
          PROJECT_BRIEF          = "PROFINET IO Controller for Water Treatment Systems"
          OUTPUT_DIRECTORY       = docs/generated/c-api
          INPUT                  = src
          FILE_PATTERNS          = *.c *.h
          RECURSIVE              = YES
          EXCLUDE_PATTERNS       = */tests/*
          GENERATE_HTML          = YES
          GENERATE_LATEX         = NO
          HTML_OUTPUT            = html
          EXTRACT_ALL            = NO
          EXTRACT_STATIC         = YES
          JAVADOC_AUTOBRIEF      = YES
          OPTIMIZE_OUTPUT_FOR_C  = YES
          HAVE_DOT               = YES
          DOT_IMAGE_FORMAT       = svg
          CALL_GRAPH             = YES
          CALLER_GRAPH           = YES
          DOT_GRAPH_MAX_NODES    = 50
          WARN_IF_UNDOCUMENTED   = YES
          WARN_NO_PARAMDOC       = YES
          WARN_LOGFILE           = doxygen-warnings.log
          SOURCE_BROWSER         = YES
          EOF

      - name: Generate Doxygen documentation
        run: |
          mkdir -p docs/generated/c-api
          doxygen Doxyfile 2>&1 | tee doxygen-output.log
          if [ -f doxygen-warnings.log ]; then
            WARN_COUNT=$(wc -l < doxygen-warnings.log)
            echo "Doxygen warnings: $WARN_COUNT"
          fi

      # --- Upload artifacts ---
      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: |
            web/api/openapi.json
            web/api/openapi.yaml
            docs/generated/
            doxygen-warnings.log
          retention-days: 14

  # ============================================================================
  # Deploy to GitHub Pages (on release or manual dispatch)
  # ============================================================================
  deploy-pages:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [validate-and-generate]
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.deploy == 'true')

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download documentation artifacts
        uses: actions/download-artifact@v4
        with:
          name: documentation
          path: docs/

      - name: Prepare pages content
        run: |
          mkdir -p _site
          cp -r docs/* _site/ 2>/dev/null || true
          cp README.md _site/
          cp CHANGELOG.md _site/ 2>/dev/null || true

          cat > _site/index.md << 'EOF'
          # Water-Controller Documentation

          ## Quick Links

          - [README](README.md) - Project overview
          - [API Reference](generated/api/openapi.yaml) - OpenAPI specification
          - [C API Reference](generated/c-api/html/index.html) - Doxygen documentation
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ============================================================================
  # Weekly Documentation Health Check
  # ============================================================================
  health-check:
    name: Documentation Health Check
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check documentation freshness
        run: |
          echo "# Documentation Health Check" > health-report.md
          echo "Generated: $(date -Iseconds)" >> health-report.md
          echo "" >> health-report.md

          echo "## Recently Modified (last 30 days)" >> health-report.md
          find . -name '*.md' -mtime -30 -not -path './node_modules/*' -not -path './.git/*' >> health-report.md || echo "None" >> health-report.md
          echo "" >> health-report.md

          echo "## Stale Documentation (>90 days)" >> health-report.md
          find . -name '*.md' -mtime +90 -not -path './node_modules/*' -not -path './.git/*' >> health-report.md || echo "None" >> health-report.md

          cat health-report.md

      - name: Upload health report
        uses: actions/upload-artifact@v4
        with:
          name: documentation-health-report
          path: health-report.md
          retention-days: 30
