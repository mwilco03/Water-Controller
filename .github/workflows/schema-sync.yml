# Schema Sync Validation Workflow
#
# This workflow ensures that generated files stay in sync with their source schemas.
# It runs on any PR that modifies schemas or generated files.
#
# Consolidated into a single job to reduce GitHub check noise.

name: Schema Sync

on:
  push:
    branches: [main, develop]
    paths:
      - 'schemas/**'
      - 'docs/generated/**'
      - 'src/generated/**'
      - 'web/api/models/generated/**'
      - 'scripts/generate_*.py'
      - 'scripts/validate_schemas.py'
      - '.github/workflows/schema-sync.yml'

  pull_request:
    paths:
      - 'schemas/**'
      - 'docs/generated/**'
      - 'src/generated/**'
      - 'web/api/models/generated/**'
      - 'scripts/generate_*.py'
      - 'scripts/validate_schemas.py'
      - '.github/workflows/schema-sync.yml'

jobs:
  schema-validation:
    name: Schema Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate schema syntax
        run: |
          python scripts/validate_schemas.py --verbose

      - name: Check for drift
        id: check-drift
        run: |
          python scripts/validate_schemas.py --check
        continue-on-error: true

      - name: Report drift status
        if: steps.check-drift.outcome == 'failure'
        run: |
          echo "::error::Generated files are out of sync with schemas!"
          echo ""
          echo "To fix this issue, run locally:"
          echo "  python scripts/validate_schemas.py --regenerate"
          echo "  git add docs/generated src/generated web/api/models/generated"
          echo "  git commit -m 'chore: regenerate files from schemas'"
          echo ""
          exit 1

      - name: Verify regeneration (PR only)
        if: github.event_name == 'pull_request'
        run: |
          # Check if schemas changed
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^schemas/'; then
            # Check if generated files were also updated
            GENERATED_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^(docs/generated|src/generated|web/api/models/generated)/' | wc -l)

            if [ "$GENERATED_CHANGED" -eq 0 ]; then
              echo "::warning::Schema files changed but generated files were not updated."
              echo "Please run: python scripts/validate_schemas.py --regenerate"
            fi
          fi

      - name: Upload diff on failure
        if: steps.check-drift.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: schema-drift-diff
          path: |
            docs/generated/
            src/generated/
            web/api/models/generated/
