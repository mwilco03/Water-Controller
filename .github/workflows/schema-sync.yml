# Schema Sync Validation Workflow
#
# This workflow ensures that generated files stay in sync with their source schemas.
# It runs on any PR that modifies schemas or generated files.
#
# The workflow:
# 1. Validates all schemas are valid JSON Schema
# 2. Regenerates all artifacts from schemas
# 3. Compares regenerated files with committed versions
# 4. Fails if any difference is detected

name: Schema Sync

on:
  push:
    branches: [main, develop]
    paths:
      - 'schemas/**'
      - 'docs/generated/**'
      - 'src/generated/**'
      - 'web/api/models/generated/**'
      - 'scripts/generate_*.py'
      - 'scripts/validate_schemas.py'
      - '.github/workflows/schema-sync.yml'

  pull_request:
    paths:
      - 'schemas/**'
      - 'docs/generated/**'
      - 'src/generated/**'
      - 'web/api/models/generated/**'
      - 'scripts/generate_*.py'
      - 'scripts/validate_schemas.py'
      - '.github/workflows/schema-sync.yml'

jobs:
  validate-schemas:
    name: Validate Schemas
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate schema syntax
        run: |
          python scripts/validate_schemas.py --verbose

  check-sync:
    name: Check Generated Files
    runs-on: ubuntu-latest
    needs: validate-schemas

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Check for drift
        id: check-drift
        run: |
          python scripts/validate_schemas.py --check
        continue-on-error: true

      - name: Report drift status
        if: steps.check-drift.outcome == 'failure'
        run: |
          echo "::error::Generated files are out of sync with schemas!"
          echo ""
          echo "To fix this issue, run locally:"
          echo "  python scripts/validate_schemas.py --regenerate"
          echo "  git add docs/generated src/generated web/api/models/generated"
          echo "  git commit -m 'chore: regenerate files from schemas'"
          echo ""
          exit 1

      - name: Upload diff on failure
        if: steps.check-drift.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: schema-drift-diff
          path: |
            docs/generated/
            src/generated/
            web/api/models/generated/

  regenerate-on-schema-change:
    name: Verify Regeneration
    runs-on: ubuntu-latest
    needs: validate-schemas
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Check if schemas changed
        id: schema-changes
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q '^schemas/'; then
            echo "schemas_changed=true" >> $GITHUB_OUTPUT
          else
            echo "schemas_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Verify generated files updated
        if: steps.schema-changes.outputs.schemas_changed == 'true'
        run: |
          # Check if generated files were also updated
          GENERATED_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^(docs/generated|src/generated|web/api/models/generated)/' | wc -l)

          if [ "$GENERATED_CHANGED" -eq 0 ]; then
            echo "::warning::Schema files changed but generated files were not updated."
            echo "Please run: python scripts/validate_schemas.py --regenerate"
          fi
