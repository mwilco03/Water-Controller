name: Build Multi-Architecture Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create GitHub release'
        required: false
        default: 'false'
        type: boolean

env:
  BUILD_TYPE: Release

jobs:
  build-native:
    name: Build x86_64 (Native)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake pkg-config \
            libpq-dev libjson-c-dev \
            libsqlite3-dev libcurl4-openssl-dev

      - name: Configure CMake
        run: cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} -DBUILD_TESTS=ON

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Run Tests
        run: cd build && ctest --output-on-failure

      - name: Package
        run: |
          mkdir -p release/water-controller-x86_64
          cp build/water_treat_controller release/water-controller-x86_64/
          cp build/lib*.so* release/water-controller-x86_64/ 2>/dev/null || true
          cp -r scripts release/water-controller-x86_64/
          cp README.md LICENSE release/water-controller-x86_64/
          cd release && tar czf water-controller-x86_64.tar.gz water-controller-x86_64

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-x86_64
          path: release/water-controller-x86_64.tar.gz

  build-arm:
    name: Build ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # ARM64 - Raspberry Pi 4/5, Orange Pi 5, Le Potato
          - name: aarch64
            arch: aarch64
            toolchain: toolchain-aarch64.cmake
            packages: gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
            triple: aarch64-linux-gnu

          # ARMv7 Hard Float - Raspberry Pi 3, Orange Pi Zero/PC
          - name: armv7hf
            arch: armv7hf
            toolchain: toolchain-arm.cmake
            packages: gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            triple: arm-linux-gnueabihf

          # ARMv6 - Luckfox Lyra, Raspberry Pi Zero
          - name: armv6
            arch: armv6
            toolchain: toolchain-arm.cmake
            packages: gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf
            triple: arm-linux-gnueabihf

    steps:
      - uses: actions/checkout@v4

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            cmake pkg-config \
            ${{ matrix.packages }}

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_TOOLCHAIN_FILE=cmake/${{ matrix.toolchain }} \
            -DARM_ARCH=${{ matrix.arch }} \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=OFF

      - name: Build
        run: cmake --build build -j$(nproc)

      - name: Package
        run: |
          mkdir -p release/water-controller-${{ matrix.name }}
          cp build/water_treat_controller release/water-controller-${{ matrix.name }}/
          cp build/lib*.so* release/water-controller-${{ matrix.name }}/ 2>/dev/null || true
          cp -r scripts release/water-controller-${{ matrix.name }}/
          cp README.md LICENSE release/water-controller-${{ matrix.name }}/
          # Strip binaries for smaller size
          ${{ matrix.triple }}-strip release/water-controller-${{ matrix.name }}/water_treat_controller || true
          cd release && tar czf water-controller-${{ matrix.name }}.tar.gz water-controller-${{ matrix.name }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-${{ matrix.name }}
          path: release/water-controller-${{ matrix.name }}.tar.gz

  build-web:
    name: Build Web UI
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: web/ui/package-lock.json

      - name: Install dependencies
        run: cd web/ui && npm ci

      - name: Build
        run: cd web/ui && npm run build

      - name: Package
        run: |
          mkdir -p release
          tar czf release/water-controller-web-ui.tar.gz -C web/ui .next public package.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: water-controller-web-ui
          path: release/water-controller-web-ui.tar.gz

  release:
    name: Create Release
    needs: [build-native, build-arm, build-web]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'

    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec cp {} release/ \;
          ls -la release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum *.tar.gz > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') }}
          files: |
            release/*.tar.gz
            release/SHA256SUMS.txt
          body: |
            ## Water Treatment Controller Release

            ### Downloads

            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux x86_64 | Intel/AMD 64-bit | `water-controller-x86_64.tar.gz` |
            | Linux ARM64 | Raspberry Pi 4/5, Orange Pi 5, Le Potato | `water-controller-aarch64.tar.gz` |
            | Linux ARMv7 | Raspberry Pi 3, Orange Pi Zero | `water-controller-armv7hf.tar.gz` |
            | Linux ARMv6 | Luckfox Lyra, Pi Zero W | `water-controller-armv6.tar.gz` |
            | Web UI | All platforms | `water-controller-web-ui.tar.gz` |

            ### Supported Boards

            - **Luckfox Lyra** - ARMv6/ARMv7
            - **Raspberry Pi 3B/3B+** - ARMv7
            - **Raspberry Pi 4B/5** - ARM64
            - **Orange Pi Zero/PC/5** - ARMv7/ARM64
            - **Libre Computer Le Potato** - ARM64

            ### Installation

            ```bash
            # Extract
            tar xzf water-controller-<arch>.tar.gz
            cd water-controller-<arch>

            # Install
            sudo ./scripts/install.sh
            ```

            See [DEPLOYMENT.md](docs/DEPLOYMENT.md) for detailed instructions.
