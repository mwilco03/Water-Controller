# Water Treatment Controller - C Controller Dockerfile
# Copyright (C) 2024
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Two-stage build: build environment -> minimal runtime

# =============================================================================
# Stage 1: Build Water Controller
# =============================================================================
FROM debian:bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    pkg-config \
    libpq-dev \
    libjson-c-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy source
WORKDIR /app
COPY CMakeLists.txt .
COPY cmake/ cmake/
COPY src/ src/
COPY shared/ shared/
COPY tests/ tests/

# Build controller (release mode, no tests)
# Build as STATIC libraries to avoid shared library issues in runtime
RUN mkdir build && cd build && \
    cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF -DBUILD_SHARED_LIBS=OFF .. && \
    make -j$(nproc) && \
    echo "=== BUILD VERIFICATION ===" && \
    ls -la water_treat_controller && \
    ldd water_treat_controller || true

# =============================================================================
# Stage 2: Runtime image (minimal)
# =============================================================================
FROM debian:bookworm-slim

# Install runtime dependencies only (includes iproute2 for interface auto-detection)
RUN apt-get update && apt-get install -y \
    libpq5 \
    libjson-c5 \
    procps \
    iproute2 \
    && rm -rf /var/lib/apt/lists/*

# Copy controller binary (statically linked to internal libs)
COPY --from=builder /app/build/water_treat_controller /usr/local/bin/

# Copy entrypoint script for interface auto-detection
COPY docker/controller-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/controller-entrypoint.sh

# Create config and log directories
RUN mkdir -p /etc/water-controller /var/log/water-controller

# Create non-root user for security
RUN groupadd -r wtc && useradd -r -g wtc wtc
RUN chown -R wtc:wtc /var/log/water-controller

# Set default environment - NO hardcoded interface
# WTC_INTERFACE can be set to override auto-detection, or left unset for auto
ENV WTC_CYCLE_TIME=1000
ENV WTC_LOG_LEVEL=INFO

# Expose OPC UA port for debugging
EXPOSE 4840/tcp

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep water_treat_controller || exit 1

# Run with capabilities for raw sockets
# docker run --cap-add=NET_ADMIN --cap-add=NET_RAW
# Interface is auto-detected by entrypoint script if WTC_INTERFACE not set
ENTRYPOINT ["/usr/local/bin/controller-entrypoint.sh"]
CMD []
