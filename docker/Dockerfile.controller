# Water Treatment Controller - C Controller Dockerfile
# Copyright (C) 2024
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Two-stage build: build environment -> minimal runtime

# =============================================================================
# Stage 1: Build Water Controller
# =============================================================================
FROM debian:bookworm-slim AS builder

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    pkg-config \
    libpq-dev \
    libjson-c-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy source
WORKDIR /app
COPY CMakeLists.txt .
COPY cmake/ cmake/
COPY src/ src/
COPY shared/ shared/
COPY tests/ tests/

# Build controller (release mode, no tests)
RUN mkdir build && cd build && \
    cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=OFF .. && \
    make -j$(nproc) && \
    echo "=== BUILD VERIFICATION ===" && \
    ls -la water_treat_controller

RUN mkdir /tmp/libs && \
    ldd /app/build/water_treat_controller \
      | awk '/=> \// { print $3 }' \
      | xargs -I '{}' cp --parents '{}' /tmp/libs

# =============================================================================
# Stage 2: Runtime image (minimal)
# =============================================================================
FROM debian:bookworm-slim

# Install runtime dependencies only
RUN apt-get update && apt-get install -y \
    libpq5 \
    libjson-c5 \
    procps \
    && rm -rf /var/lib/apt/lists/*

# Copy controller binary
COPY --from=builder /app/build/water_treat_controller /usr/local/bin/

# Copy required shared libraries
COPY --from=builder /tmp/libs/ /

# Rebuild dynamic linker cache
RUN ldconfig

# Create config and log directories
RUN mkdir -p /etc/water-controller /var/log/water-controller

# Create non-root user for security
RUN groupadd -r wtc && useradd -r -g wtc wtc
RUN chown -R wtc:wtc /var/log/water-controller

# Set default environment
ENV WTC_INTERFACE=eth0
ENV WTC_CYCLE_TIME=1000
ENV WTC_LOG_LEVEL=INFO

# Expose OPC UA port for debugging
EXPOSE 4840/tcp

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep water_treat_controller || exit 1

# Run with capabilities for raw sockets
# docker run --cap-add=NET_ADMIN --cap-add=NET_RAW
ENTRYPOINT ["water_treat_controller"]
CMD ["-i", "eth0", "-t", "1000"]
