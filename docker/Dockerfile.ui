# Water Treatment Controller - React HMI Frontend
# Copyright (C) 2024
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Multi-stage build for Next.js frontend
# Multi-architecture supporting:
#   - linux/amd64  (x86_64)
#   - linux/arm64  (Raspberry Pi 4/5, ARM servers)
#   - linux/arm/v7 (Raspberry Pi 3, older ARM)

# Global build arguments (available in all stages when redeclared)
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

# =============================================================================
# Base stage - Common Node.js image
# =============================================================================
FROM node:18-alpine AS base

# =============================================================================
# Dependencies stage - Install npm packages
# =============================================================================
FROM base AS deps
WORKDIR /app

# Copy package files
COPY web/ui/package.json web/ui/package-lock.json* ./

# Install dependencies
RUN npm ci --legacy-peer-deps

# =============================================================================
# Builder stage - Build the Next.js application
# =============================================================================
FROM base AS builder
WORKDIR /app

# Copy dependencies from deps stage
COPY --from=deps /app/node_modules ./node_modules
COPY web/ui/ .

# Disable telemetry during build
ENV NEXT_TELEMETRY_DISABLED=1

# Download fonts for air-gapped deployment (no external network calls at runtime)
RUN apk add --no-cache curl unzip && \
    chmod +x scripts/download-fonts.sh && \
    ./scripts/download-fonts.sh || echo "Font download skipped - using system fallbacks" && \
    apk del curl unzip

# Build the application
RUN npm run build

# =============================================================================
# Runner stage - Production image
# =============================================================================
FROM base AS runner
WORKDIR /app

# Redeclare ARGs to use in this stage (required for multi-stage builds)
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION

# OCI Image Labels
LABEL org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.authors="Water Controller Team" \
      org.opencontainers.image.url="https://github.com/mwilco03/Water-Controller" \
      org.opencontainers.image.documentation="https://github.com/mwilco03/Water-Controller/blob/main/docs/DEPLOYMENT.md" \
      org.opencontainers.image.source="https://github.com/mwilco03/Water-Controller" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Water Controller Project" \
      org.opencontainers.image.licenses="GPL-3.0-or-later" \
      org.opencontainers.image.title="Water Controller UI" \
      org.opencontainers.image.description="Next.js HMI frontend for Water Treatment Controller SCADA system"

# Set production environment
ENV NODE_ENV=production \
    NEXT_TELEMETRY_DISABLED=1 \
    PORT=3000 \
    HOSTNAME="0.0.0.0"

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nextjs

# Copy built assets from builder
COPY --from=builder /app/public ./public
COPY --from=builder --chown=nextjs:nodejs /app/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/.next/static ./.next/static

# Switch to non-root user
USER nextjs

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD wget -q --spider http://localhost:3000 || exit 1

# Start the server
CMD ["node", "server.js"]
